# ARM64 æ„å»ºæ­¥éª¤ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ¯ é—®é¢˜åˆ†æ
"Build and push ARM64 CentOS 7.9 image" æ­¥éª¤æ…¢çš„ä¸»è¦åŸå› ï¼š

1. **è·¨æ¶æ„æ¨¡æ‹Ÿå¼€é”€** - åœ¨ x86_64 ä¸Šæ„å»º ARM64 é•œåƒéœ€è¦ QEMU æ¨¡æ‹Ÿ
2. **ç½‘ç»œ I/O å¯†é›†** - yum ä¸‹è½½å¤§é‡è½¯ä»¶åŒ…ï¼ˆJavaã€LibreOfficeã€å­—ä½“ï¼‰
3. **ä¸²è¡Œå¤„ç†** - åŸå§‹ Dockerfile å±‚é—´ä¾èµ–å¯¼è‡´æ— æ³•å¹¶è¡Œ
4. **ç¼“å­˜æœªå……åˆ†åˆ©ç”¨** - ç¼“å­˜ç­–ç•¥ä¸å¤Ÿç²¾ç»†

## âš¡ é’ˆå¯¹æ€§ä¼˜åŒ–æªæ–½

### 1. å¢å¼º Docker Buildx é…ç½®
```yaml
# å¯ç”¨ç½‘ç»œä¸»æœºæ¨¡å¼å’Œæ›´å¤§çš„æ—¥å¿—ç¼“å†²åŒº
driver-opts: |
  network=host
  env.BUILDKIT_STEP_LOG_MAX_SIZE=50000000
  env.BUILDKIT_STEP_LOG_MAX_SPEED=100000000

buildkitd-flags: |
  --allow-insecure-entitlement=network.host
  --allow-insecure-entitlement=security.insecure
```

### 2. ç²¾ç»†åŒ–ç¼“å­˜ç­–ç•¥
```yaml
# åˆ†å±‚ç¼“å­˜ï¼Œæé«˜å‘½ä¸­ç‡
cache-from: |
  type=gha,scope=build-${{ github.ref_name }}
  type=gha,scope=build-main
  type=registry,ref=...:buildcache-${{ github.ref_name }}
  type=registry,ref=...:buildcache-main
```

### 3. Dockerfile æ€§èƒ½ä¼˜åŒ–
- **yum å¹¶è¡Œä¸‹è½½**: `max_parallel_downloads=8`
- **ç¦ç”¨ delta RPM**: `deltarpm=0` å‡å°‘ CPU å¼€é”€
- **ç«‹å³ç¼“å­˜æ¸…ç†**: å‡å°‘å±‚å¤§å°
- **å‡å°‘éªŒè¯è¾“å‡º**: æ„å»ºæ—¶éªŒè¯ä½†å‡å°‘æ—¥å¿—

### 4. ç½‘ç»œå’Œ I/O ä¼˜åŒ–
- **ç½‘ç»œä¸»æœºæ¨¡å¼**: å‡å°‘ç½‘ç»œæ ˆå¼€é”€
- **fastestmirror**: è‡ªåŠ¨é€‰æ‹©æœ€å¿«é•œåƒæº
- **keepcache=0**: é¿å…ç¼“å­˜ç´¯ç§¯

## ğŸ“Š é¢„æœŸæ€§èƒ½æå‡

| ä¼˜åŒ–é¡¹ | é¢„æœŸèŠ‚çœæ—¶é—´ | è¯´æ˜ |
|--------|-------------|------|
| å¢å¼º Buildx é…ç½® | 2-3 åˆ†é’Ÿ | ç½‘ç»œå’Œå¹¶è¡Œä¼˜åŒ– |
| ç²¾ç»†åŒ–ç¼“å­˜ | 8-12 åˆ†é’Ÿ | æ›´é«˜ç¼“å­˜å‘½ä¸­ç‡ |
| yum å¹¶è¡Œä¸‹è½½ | 1-2 åˆ†é’Ÿ | è½¯ä»¶åŒ…ä¸‹è½½åŠ é€Ÿ |
| å‡å°‘æ—¥å¿—è¾“å‡º | 0.5-1 åˆ†é’Ÿ | I/O å‡å°‘ |
| **æ€»è®¡** | **11.5-18 åˆ†é’Ÿ** | **ä» 16 åˆ†é’Ÿé™è‡³ 4-8 åˆ†é’Ÿ** |

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### æœ¬åœ°æµ‹è¯•ä¼˜åŒ–æ•ˆæœ
```bash
# è¿è¡Œä¼˜åŒ–æµ‹è¯•è„šæœ¬
./optimize-arm64-build.sh
```

### GitHub Actions ä¸­çš„æ•ˆæœ
æ„å»ºæ­¥éª¤ç°åœ¨åŒ…å«ï¼š
- ä¼˜åŒ–çš„æ„å»ºå™¨é…ç½®
- å¤šçº§ç¼“å­˜ç­–ç•¥  
- ARM64 ç‰¹å®šçš„ç½‘ç»œä¼˜åŒ–
- å¹¶è¡Œæ„å»ºå‚æ•°

## ğŸš€ è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®

### 1. ä½¿ç”¨é¢„æ„å»ºåŸºç¡€é•œåƒ
è€ƒè™‘åˆ›å»ºä¸€ä¸ªåŒ…å« Java 8 çš„åŸºç¡€é•œåƒï¼š
```dockerfile
# åˆ›å»º arm64-centos-java8 åŸºç¡€é•œåƒ
FROM arm64v8/centos:7.9.2009
RUN # åªå®‰è£… Java 8 å’ŒåŸºç¡€é…ç½®
```

### 2. è½¯ä»¶åŒ…ç¼“å­˜
åœ¨ GitHub Actions ä¸­ç¼“å­˜ yum ä¸‹è½½ï¼š
```yaml
- name: Cache yum packages
  uses: actions/cache@v3
  with:
    path: /var/cache/yum
    key: yum-${{ runner.os }}-${{ hashFiles('Dockerfile') }}
```

### 3. å¤šé˜¶æ®µæ„å»º
å°†å­—ä½“å®‰è£…åˆ†ç¦»åˆ°å•ç‹¬é˜¶æ®µï¼š
```dockerfile
FROM base AS fonts
RUN # å®‰è£…æ‰€æœ‰å­—ä½“åŒ…

FROM base AS final
COPY --from=fonts /usr/share/fonts /usr/share/fonts
```

## ğŸ¯ ç›‘æ§æ„å»ºæ€§èƒ½

å…³é”®æŒ‡æ ‡ï¼š
- **ç¬¬ä¸€æ¬¡æ„å»º**: ç›®æ ‡ < 8 åˆ†é’Ÿï¼ˆvs åŸæ¥ 16 åˆ†é’Ÿï¼‰
- **ç¼“å­˜å‘½ä¸­æ„å»º**: ç›®æ ‡ < 5 åˆ†é’Ÿ
- **ç¼“å­˜å‘½ä¸­ç‡**: ç›®æ ‡ > 80%

## ğŸ“ éªŒè¯æ¸…å•

- [ ] Docker Buildx é…ç½®å·²ä¼˜åŒ–
- [ ] ç¼“å­˜ç­–ç•¥å·²æ›´æ–°ä¸ºåˆ†å±‚æ¨¡å¼
- [ ] Dockerfile yum é…ç½®å·²ä¼˜åŒ–
- [ ] ç½‘ç»œä¸»æœºæ¨¡å¼å·²å¯ç”¨
- [ ] éªŒè¯è„šæœ¬æµ‹è¯•é€šè¿‡
- [ ] GitHub Actions æ„å»ºæ—¶é—´å·²ç¼©çŸ­

ä½¿ç”¨ `./validate-optimization.sh` éªŒè¯æ‰€æœ‰ä¼˜åŒ–æ˜¯å¦æ­£ç¡®åº”ç”¨ã€‚